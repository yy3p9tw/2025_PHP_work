<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ Firebase æ¸¬è©¦é é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: #f9f9f9;
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ Firebase æ•´åˆæ¸¬è©¦</h1>
            <p>æ¸¬è©¦ Firebase Firestore è³‡æ–™åº«é€£ç·šèˆ‡åŸºæœ¬æ“ä½œ</p>
        </div>

        <div class="content">
            <!-- é€£ç·šç‹€æ…‹ -->
            <div class="test-section">
                <h3>ğŸ”Œ é€£ç·šç‹€æ…‹</h3>
                <div id="connectionStatus" class="status info">ğŸ”„ æ­£åœ¨é€£ç·š...</div>
                <button class="btn" onclick="testConnection()">é‡æ–°æ¸¬è©¦é€£ç·š</button>
            </div>

            <!-- æ¸¬è©¦è¨‚å–®å„²å­˜ -->
            <div class="test-section">
                <h3>ğŸ’¾ æ¸¬è©¦è¨‚å–®å„²å­˜</h3>
                
                <div class="form-group">
                    <label>æ¡Œè™Ÿï¼š</label>
                    <input type="text" id="testTableNumber" value="A01" placeholder="ä¾‹å¦‚ï¼šA01">
                </div>
                
                <div class="form-group">
                    <label>é¡§å®¢å§“åï¼š</label>
                    <input type="text" id="testCustomerName" value="æ¸¬è©¦é¡§å®¢" placeholder="è¼¸å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label>è¨‚å–®å‚™è¨»ï¼š</label>
                    <textarea id="testOrderNote" placeholder="ç‰¹æ®Šéœ€æ±‚...">ä¸è¦è¾£æ¤’</textarea>
                </div>
                
                <button class="btn" onclick="testSaveOrder()">ğŸ’¾ å„²å­˜æ¸¬è©¦è¨‚å–®</button>
                <div id="saveOrderStatus"></div>
            </div>

            <!-- æ¸¬è©¦è®€å–è¨‚å–® -->
            <div class="test-section">
                <h3>ğŸ“‹ æ¸¬è©¦è®€å–è¨‚å–®</h3>
                <button class="btn" onclick="testGetOrders()">ğŸ“‹ è®€å–æ‰€æœ‰è¨‚å–®</button>
                <button class="btn" onclick="testGetPendingOrders()">â³ è®€å–å¾…è™•ç†è¨‚å–®</button>
                <div id="getOrdersStatus"></div>
                <div id="ordersList" class="log"></div>
            </div>

            <!-- æ¸¬è©¦å³æ™‚ç›£è½ -->
            <div class="test-section">
                <h3>ğŸ”„ æ¸¬è©¦å³æ™‚ç›£è½</h3>
                <button class="btn" onclick="startListening()" id="listenBtn">ğŸ§ é–‹å§‹ç›£è½</button>
                <button class="btn" onclick="stopListening()" id="stopListenBtn" disabled>â¹ï¸ åœæ­¢ç›£è½</button>
                <div id="listenStatus"></div>
                <div id="realtimeOrders" class="log"></div>
            </div>

            <!-- æ“ä½œè¨˜éŒ„ -->
            <div class="test-section">
                <h3>ğŸ“ æ“ä½œè¨˜éŒ„</h3>
                <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                <div id="operationLog" class="log"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Firebase è¨­å®šèˆ‡åˆå§‹åŒ– -->
    <script type="module">        // ğŸ”¥ Firebase å°ˆæ¡ˆè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBUNTVoTyNAuolkwhEvzOeRSWg8dgXJ9Bs",
            authDomain: "restaurant-qr-system.firebaseapp.com",
            projectId: "restaurant-qr-system",
            storageBucket: "restaurant-qr-system.firebasestorage.app",
            messagingSenderId: "704292695294",
            appId: "1:704292695294:web:8c8ad1c3ece056dae649af"
        };

        // åˆå§‹åŒ– Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            window.firebaseDb = firebase.firestore();
            window.firebase = firebase;
            
            log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
            updateConnectionStatus('âœ… å·²é€£ç·šåˆ° Firebase', 'success');
        } catch (error) {
            log('âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            updateConnectionStatus('âŒ Firebase é€£ç·šå¤±æ•—: ' + error.message, 'error');
        }
    </script>

    <!-- è¼‰å…¥ Firebase æœå‹™ -->
    <script src="js/services/FirebaseService.js"></script>

    <script>
        let firebaseService = null;
        let orderListener = null;

        // åˆå§‹åŒ– Firebase æœå‹™
        async function initFirebaseService() {
            try {
                firebaseService = new FirebaseService();
                await firebaseService.init();
                return true;
            } catch (error) {
                log('âŒ FirebaseService åˆå§‹åŒ–å¤±æ•—: ' + error.message);
                return false;
            }
        }

        // æ¸¬è©¦é€£ç·š
        async function testConnection() {
            updateConnectionStatus('ğŸ”„ æ­£åœ¨æ¸¬è©¦é€£ç·š...', 'info');
            
            const success = await initFirebaseService();
            if (success) {
                updateConnectionStatus('âœ… Firebase æœå‹™é€£ç·šæˆåŠŸ', 'success');
                log('âœ… é€£ç·šæ¸¬è©¦é€šé');
            } else {
                updateConnectionStatus('âŒ Firebase æœå‹™é€£ç·šå¤±æ•—', 'error');
            }
        }

        // æ¸¬è©¦å„²å­˜è¨‚å–®
        async function testSaveOrder() {
            if (!firebaseService) {
                const success = await initFirebaseService();
                if (!success) return;
            }

            const tableNumber = document.getElementById('testTableNumber').value;
            const customerName = document.getElementById('testCustomerName').value;
            const orderNote = document.getElementById('testOrderNote').value;

            const testOrder = {
                tableNumber: tableNumber || 'A01',
                customerName: customerName || 'æ¸¬è©¦é¡§å®¢',
                items: [
                    { id: 1, name: 'ç‰›è‚‰éºµ', price: 200, quantity: 1 },
                    { id: 2, name: 'çç å¥¶èŒ¶', price: 60, quantity: 2 }
                ],
                totalAmount: 320,
                paymentMethod: 'cash',
                note: orderNote || 'æ¸¬è©¦è¨‚å–®',
                source: 'firebase-test-page'
            };

            try {
                updateStatus('saveOrderStatus', 'ğŸ’¾ æ­£åœ¨å„²å­˜è¨‚å–®...', 'info');
                
                const result = await firebaseService.saveOrder(testOrder);
                
                updateStatus('saveOrderStatus', 'âœ… è¨‚å–®å„²å­˜æˆåŠŸï¼è¨‚å–® ID: ' + result.orderId, 'success');
                log(`âœ… æ¸¬è©¦è¨‚å–®å„²å­˜æˆåŠŸï¼ŒID: ${result.orderId}`);
                
            } catch (error) {
                updateStatus('saveOrderStatus', 'âŒ å„²å­˜å¤±æ•—: ' + error.message, 'error');
                log('âŒ æ¸¬è©¦è¨‚å–®å„²å­˜å¤±æ•—: ' + error.message);
            }
        }

        // æ¸¬è©¦è®€å–æ‰€æœ‰è¨‚å–®
        async function testGetOrders() {
            if (!firebaseService) {
                const success = await initFirebaseService();
                if (!success) return;
            }

            try {
                updateStatus('getOrdersStatus', 'ğŸ“‹ æ­£åœ¨è®€å–è¨‚å–®...', 'info');
                
                const orders = await firebaseService.getOrders();
                
                updateStatus('getOrdersStatus', `âœ… æˆåŠŸè®€å– ${orders.length} ç­†è¨‚å–®`, 'success');
                displayOrders(orders, 'ordersList');
                log(`âœ… æˆåŠŸè®€å– ${orders.length} ç­†è¨‚å–®`);
                
            } catch (error) {
                updateStatus('getOrdersStatus', 'âŒ è®€å–å¤±æ•—: ' + error.message, 'error');
                log('âŒ è®€å–è¨‚å–®å¤±æ•—: ' + error.message);
            }
        }

        // æ¸¬è©¦è®€å–å¾…è™•ç†è¨‚å–®
        async function testGetPendingOrders() {
            if (!firebaseService) {
                const success = await initFirebaseService();
                if (!success) return;
            }

            try {
                updateStatus('getOrdersStatus', 'â³ æ­£åœ¨è®€å–å¾…è™•ç†è¨‚å–®...', 'info');
                
                const orders = await firebaseService.getOrders({ status: 'pending' });
                
                updateStatus('getOrdersStatus', `âœ… æˆåŠŸè®€å– ${orders.length} ç­†å¾…è™•ç†è¨‚å–®`, 'success');
                displayOrders(orders, 'ordersList');
                log(`âœ… æˆåŠŸè®€å– ${orders.length} ç­†å¾…è™•ç†è¨‚å–®`);
                
            } catch (error) {
                updateStatus('getOrdersStatus', 'âŒ è®€å–å¤±æ•—: ' + error.message, 'error');
                log('âŒ è®€å–å¾…è™•ç†è¨‚å–®å¤±æ•—: ' + error.message);
            }
        }

        // é–‹å§‹å³æ™‚ç›£è½
        async function startListening() {
            if (!firebaseService) {
                const success = await initFirebaseService();
                if (!success) return;
            }

            try {
                updateStatus('listenStatus', 'ğŸ§ æ­£åœ¨å»ºç«‹å³æ™‚ç›£è½...', 'info');
                
                orderListener = firebaseService.listenToOrders((orders, error) => {
                    if (error) {
                        updateStatus('listenStatus', 'âŒ ç›£è½éŒ¯èª¤: ' + error.message, 'error');
                        log('âŒ å³æ™‚ç›£è½éŒ¯èª¤: ' + error.message);
                        return;
                    }
                    
                    updateStatus('listenStatus', `ğŸ”„ å³æ™‚æ›´æ–°ï¼šæ”¶åˆ° ${orders.length} ç­†è¨‚å–®`, 'success');
                    displayOrders(orders, 'realtimeOrders');
                    log(`ğŸ”„ å³æ™‚ç›£è½æ›´æ–°ï¼š${orders.length} ç­†è¨‚å–®`);
                });
                
                document.getElementById('listenBtn').disabled = true;
                document.getElementById('stopListenBtn').disabled = false;
                log('âœ… å³æ™‚ç›£è½å·²å•Ÿå‹•');
                
            } catch (error) {
                updateStatus('listenStatus', 'âŒ ç›£è½å¤±æ•—: ' + error.message, 'error');
                log('âŒ å•Ÿå‹•å³æ™‚ç›£è½å¤±æ•—: ' + error.message);
            }
        }

        // åœæ­¢å³æ™‚ç›£è½
        function stopListening() {
            if (orderListener) {
                orderListener();
                orderListener = null;
                
                updateStatus('listenStatus', 'â¹ï¸ å·²åœæ­¢å³æ™‚ç›£è½', 'info');
                document.getElementById('listenBtn').disabled = false;
                document.getElementById('stopListenBtn').disabled = true;
                log('â¹ï¸ å³æ™‚ç›£è½å·²åœæ­¢');
            }
        }

        // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
        function displayOrders(orders, containerId) {
            const container = document.getElementById(containerId);
            if (orders.length === 0) {
                container.innerHTML = 'ğŸ“ æš«ç„¡è¨‚å–®è³‡æ–™';
                return;
            }

            let html = '';
            orders.forEach((order, index) => {
                const createdAt = order.createdAt ? 
                    new Date(order.createdAt.toDate()).toLocaleString('zh-TW') : 
                    'æ™‚é–“æœªçŸ¥';
                
                html += `
                    <div style="border-bottom: 1px solid #ddd; padding: 10px 0;">
                        <strong>ğŸ“‹ è¨‚å–® ${index + 1} (ID: ${order.id})</strong><br>
                        ğŸ·ï¸ æ¡Œè™Ÿ: ${order.tableNumber}<br>
                        ğŸ‘¤ é¡¾å®¢: ${order.customerName || 'æœªæä¾›'}<br>
                        ğŸ’° é‡‘é¡: $${order.totalAmount}<br>
                        ğŸ“… æ™‚é–“: ${createdAt}<br>
                        ğŸ“‹ ç‹€æ…‹: ${order.status}<br>
                        ğŸ“ å‚™è¨»: ${order.note || 'ç„¡'}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ›´æ–°é€£ç·šç‹€æ…‹
        function updateConnectionStatus(message, type) {
            const element = document.getElementById('connectionStatus');
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // è¨˜éŒ„æ“ä½œ
        function log(message) {
            const logElement = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ¸…é™¤è¨˜éŒ„
        function clearLog() {
            document.getElementById('operationLog').innerHTML = '';
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•æ¸¬è©¦é€£ç·š
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
