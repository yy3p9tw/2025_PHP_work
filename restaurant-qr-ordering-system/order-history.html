<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“‹ è¨‚å–®æ­·å² - é¤å»³é»é¤ç³»çµ±</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .order-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .order-number {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .order-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.paid {
            background: #d4edda;
            color: #155724;
        }

        .order-status.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .order-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
        }

        .order-info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }

        .order-info-value {
            font-weight: 500;
            color: #333;
        }

        .order-items {
            margin-top: 15px;
        }

        .order-items-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            color: #333;
        }

        .item-quantity {
            color: #666;
            margin: 0 15px;
        }

        .item-price {
            font-weight: 500;
            color: var(--primary-color);
        }

        .order-total {
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--primary-color);
        }

        .total-label {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .total-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #ddd;
        }

        .filter-tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-tab:not(.active):hover {
            background: #f5f5f5;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        @media (max-width: 768px) {
            .order-info {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <button class="btn-back" onclick="history.back()">
                    â† è¿”å›
                </button>
                <h1 class="navbar-title">ğŸ“‹ è¨‚å–®æ­·å²</h1>
                <div class="table-info">
                    <span id="currentTableNumber">åº§è™Ÿï¼š--</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="main-content">
        <div class="container">
            <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
            <div class="loading-state" id="loadingState">
                <div class="loading"></div>
                <p class="mt-3">è¼‰å…¥è¨‚å–®è¨˜éŒ„ä¸­...</p>
            </div>

            <!-- ç¯©é¸æ¨™ç±¤ -->
            <div class="filter-tabs d-none" id="filterTabs">
                <div class="filter-tab active" data-filter="all">
                    ğŸ“‹ å…¨éƒ¨
                </div>
                <div class="filter-tab" data-filter="pending">
                    â³ è™•ç†ä¸­
                </div>
                <div class="filter-tab" data-filter="paid">
                    âœ… å·²ä»˜æ¬¾
                </div>
                <div class="filter-tab" data-filter="completed">
                    ğŸ‰ å·²å®Œæˆ
                </div>
            </div>

            <!-- è¨‚å–®åˆ—è¡¨ -->
            <div class="orders-list d-none" id="ordersList">
                <!-- è¨‚å–®å¡ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div class="empty-state d-none" id="emptyState">
                <div class="empty-state-icon">ğŸ“‹</div>
                <h3>æš«ç„¡è¨‚å–®è¨˜éŒ„</h3>
                <p>æ‚¨é‚„æ²’æœ‰ä»»ä½•è¨‚å–®è¨˜éŒ„</p>
                <a href="menu.html" class="btn btn-primary mt-3">é–‹å§‹é»é¤</a>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Firebase è¨­å®šèˆ‡åˆå§‹åŒ– -->
    <script type="module">        // ğŸ”¥ Firebase å°ˆæ¡ˆè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBUNTVoTyNAuolkwhEvzOeRSWg8dgXJ9Bs",
            authDomain: "restaurant-qr-system.firebaseapp.com",
            projectId: "restaurant-qr-system",
            storageBucket: "restaurant-qr-system.firebasestorage.app",
            messagingSenderId: "704292695294",
            appId: "1:704292695294:web:8c8ad1c3ece056dae649af"
        };

        // åˆå§‹åŒ– Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            window.firebaseDb = firebase.firestore();
            window.firebase = firebase;
            console.log('ğŸ”¥ Firebase å·²åˆå§‹åŒ–');
        } catch (error) {
            console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            window.isFirebaseEnabled = false;
        }
    </script>

    <!-- è¼‰å…¥æœå‹™èˆ‡é é¢é‚è¼¯ -->
    <script src="js/services/FirebaseService.js"></script>
    <script>
        class OrderHistoryPage {
            constructor() {
                this.firebaseService = null;
                this.isFirebaseEnabled = false;
                this.currentFilter = 'all';
                this.allOrders = [];
                
                this.init();
            }

            async init() {
                console.log('ğŸ“‹ è¨‚å–®æ­·å²é é¢åˆå§‹åŒ–ä¸­...');
                
                // åˆå§‹åŒ– Firebase æœå‹™
                await this.initFirebaseService();
                
                // æª¢æŸ¥åº§è™Ÿ
                this.checkTableNumber();
                
                // è¨­å®šäº‹ä»¶ç›£è½
                this.setupEventListeners();
                
                // è¼‰å…¥è¨‚å–®è³‡æ–™
                await this.loadOrders();
                
                console.log('âœ… è¨‚å–®æ­·å²é é¢åˆå§‹åŒ–å®Œæˆ');
            }

            async initFirebaseService() {
                try {
                    if (typeof window.FirebaseService !== 'undefined' && window.firebaseDb) {
                        this.firebaseService = new FirebaseService();
                        await this.firebaseService.init();
                        this.isFirebaseEnabled = true;
                        console.log('ğŸ”¥ Firebase æœå‹™å·²å•Ÿç”¨');
                    } else {
                        console.log('ğŸ“± Firebase æœªå•Ÿç”¨ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜æ¨¡å¼');
                        this.isFirebaseEnabled = false;
                    }
                } catch (error) {
                    console.warn('âš ï¸ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜æ¨¡å¼:', error);
                    this.isFirebaseEnabled = false;
                }
            }

            checkTableNumber() {
                const savedTable = localStorage.getItem('currentTable');
                if (savedTable) {
                    const tableData = JSON.parse(savedTable);
                    const tableDisplay = document.getElementById('currentTableNumber');
                    if (tableDisplay) {
                        tableDisplay.textContent = `åº§è™Ÿï¼š${tableData.number}`;
                    }
                }
            }

            setupEventListeners() {
                // ç¯©é¸æ¨™ç±¤é»æ“Šäº‹ä»¶
                const filterTabs = document.querySelectorAll('.filter-tab');
                filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const filter = tab.dataset.filter;
                        this.setActiveFilter(filter);
                        this.filterOrders(filter);
                    });
                });
            }

            setActiveFilter(filter) {
                this.currentFilter = filter;
                
                // æ›´æ–°æ¨™ç±¤æ¨£å¼
                const filterTabs = document.querySelectorAll('.filter-tab');
                filterTabs.forEach(tab => {
                    if (tab.dataset.filter === filter) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });
            }

            async loadOrders() {
                try {
                    this.showLoading(true);
                    
                    let orders = [];
                    
                    if (this.isFirebaseEnabled) {
                        // å¾ Firebase è¼‰å…¥
                        orders = await this.loadFromFirebase();
                    } else {
                        // å¾æœ¬åœ°å„²å­˜è¼‰å…¥
                        orders = this.loadFromLocal();
                    }
                    
                    this.allOrders = orders;
                    this.displayOrders(orders);
                    
                    console.log(`âœ… è¼‰å…¥ ${orders.length} ç­†è¨‚å–®è¨˜éŒ„`);
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                    this.showError('è¼‰å…¥è¨‚å–®è¨˜éŒ„å¤±æ•—');
                } finally {
                    this.showLoading(false);
                }
            }

            async loadFromFirebase() {
                try {
                    const orders = await this.firebaseService.getOrders();
                    return orders.map(order => ({
                        ...order,
                        source: 'firebase'
                    }));
                } catch (error) {
                    console.warn('âš ï¸ Firebase è¼‰å…¥å¤±æ•—ï¼Œå›é€€åˆ°æœ¬åœ°å„²å­˜');
                    return this.loadFromLocal();
                }
            }

            loadFromLocal() {
                const orders = JSON.parse(localStorage.getItem('submittedOrders') || '[]');
                return orders.map(order => ({
                    ...order,
                    source: 'local'
                }));
            }

            filterOrders(filter) {
                let filteredOrders = this.allOrders;
                
                if (filter !== 'all') {
                    filteredOrders = this.allOrders.filter(order => {
                        const status = order.orderStatus || order.status || 'pending';
                        return status === filter;
                    });
                }
                
                this.displayOrders(filteredOrders);
                console.log(`ğŸ“‹ ç¯©é¸çµæœ: ${filteredOrders.length} ç­†è¨‚å–® (${filter})`);
            }

            displayOrders(orders) {
                const ordersList = document.getElementById('ordersList');
                const emptyState = document.getElementById('emptyState');
                const filterTabs = document.getElementById('filterTabs');
                
                if (orders.length === 0) {
                    ordersList.classList.add('d-none');
                    emptyState.classList.remove('d-none');
                    filterTabs.classList.add('d-none');
                } else {
                    ordersList.classList.remove('d-none');
                    emptyState.classList.add('d-none');
                    filterTabs.classList.remove('d-none');
                    
                    // ç”Ÿæˆè¨‚å–®å¡ç‰‡
                    ordersList.innerHTML = orders.map(order => this.createOrderCard(order)).join('');
                }
            }

            createOrderCard(order) {
                const statusMap = {
                    'pending': { text: 'è™•ç†ä¸­', class: 'pending' },
                    'awaiting_payment': { text: 'ç­‰å¾…ä»˜æ¬¾', class: 'pending' },
                    'paid': { text: 'å·²ä»˜æ¬¾', class: 'paid' },
                    'completed': { text: 'å·²å®Œæˆ', class: 'completed' }
                };
                
                const status = statusMap[order.orderStatus || order.status || 'pending'] || statusMap.pending;
                
                const createdAt = order.createdAt ? 
                    (order.createdAt.toDate ? 
                        order.createdAt.toDate().toLocaleString('zh-TW') : 
                        new Date(order.createdAt).toLocaleString('zh-TW')) :
                    new Date(order.submittedAt || Date.now()).toLocaleString('zh-TW');

                const orderId = order.id || order.firebaseId || order.localId || order.orderNumber;
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-number">ğŸ“‹ è¨‚å–® ${orderId}</div>
                            <div class="order-status ${status.class}">${status.text}</div>
                        </div>
                        
                        <div class="order-info">
                            <div class="order-info-item">
                                <div class="order-info-label">æ¡Œè™Ÿ</div>
                                <div class="order-info-value">ğŸ·ï¸ ${order.tableNumber}</div>
                            </div>
                            <div class="order-info-item">
                                <div class="order-info-label">ä¸‹å–®æ™‚é–“</div>
                                <div class="order-info-value">ğŸ“… ${createdAt}</div>
                            </div>
                            <div class="order-info-item">
                                <div class="order-info-label">ä»˜æ¬¾æ–¹å¼</div>
                                <div class="order-info-value">ğŸ’³ ${this.getPaymentMethodName(order.paymentMethod)}</div>
                            </div>
                            <div class="order-info-item">
                                <div class="order-info-label">è³‡æ–™ä¾†æº</div>
                                <div class="order-info-value">${order.source === 'firebase' ? 'ğŸ”¥ é›²ç«¯' : 'ğŸ“± æœ¬åœ°'}</div>
                            </div>
                        </div>
                        
                        ${order.note ? `
                            <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <strong>å‚™è¨»ï¼š</strong> ${order.note}
                            </div>
                        ` : ''}
                        
                        <div class="order-items">
                            <div class="order-items-title">è¨‚å–®é …ç›®ï¼š</div>
                            ${order.items.map(item => `
                                <div class="order-item">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-quantity">x${item.quantity}</div>
                                    <div class="item-price">$${item.price * item.quantity}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="order-total">
                            <span class="total-label">ç¸½é‡‘é¡ï¼š</span>
                            <span class="total-amount">$${order.totalAmount}</span>
                        </div>
                    </div>
                `;
            }

            getPaymentMethodName(method) {
                const methodMap = {
                    'cash': 'ç¾é‡‘ä»˜æ¬¾',
                    'card': 'ä¿¡ç”¨å¡',
                    'mobile': 'è¡Œå‹•æ”¯ä»˜'
                };
                return methodMap[method] || method;
            }

            showLoading(show) {
                const loadingState = document.getElementById('loadingState');
                const ordersList = document.getElementById('ordersList');
                const emptyState = document.getElementById('emptyState');
                const filterTabs = document.getElementById('filterTabs');
                
                if (show) {
                    loadingState.classList.remove('d-none');
                    ordersList.classList.add('d-none');
                    emptyState.classList.add('d-none');
                    filterTabs.classList.add('d-none');
                } else {
                    loadingState.classList.add('d-none');
                }
            }

            showError(message) {
                const ordersList = document.getElementById('ordersList');
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary mt-3" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>
                    </div>
                `;
                ordersList.classList.remove('d-none');
            }
        }

        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', () => {
            new OrderHistoryPage();
        });
    </script>
</body>
</html>
