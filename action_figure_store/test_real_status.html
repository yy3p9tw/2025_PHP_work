<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分類狀態切換實際測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .status-badge {
            transition: all 0.2s ease;
            user-select: none;
            cursor: pointer;
        }
        .status-badge:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        .category-item {
            transition: background-color 0.2s ease;
            border-radius: 4px;
            margin: 2px 0;
        }
        .category-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>分類狀態切換實際測試</h1>
        
        <div class="alert alert-info">
            <h5><i class="bi bi-info-circle"></i> 測試說明：</h5>
            <p>這個頁面直接連接到資料庫，測試分類狀態切換功能。點擊狀態徽章來切換啟用/停用狀態。</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-list-task"></i> 分類列表</h5>
                        <button class="btn btn-sm btn-primary" onclick="loadCategories()">
                            <i class="bi bi-arrow-clockwise"></i> 重新載入
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="categoriesList">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">載入中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-journal-text"></i> 操作日誌</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">清除</button>
                    </div>
                    <div class="card-body">
                        <div id="operationLog" style="height: 300px; overflow-y: auto; font-size: 0.9em;">
                            <!-- 日誌將在這裡顯示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="admin/categories.php" class="btn btn-success">
                <i class="bi bi-gear"></i> 前往分類管理
            </a>
            <a href="admin/index.php" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-in-right"></i> 後台登入
            </a>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('operationLog');
            const time = new Date().toLocaleTimeString();
            const colorClass = {
                'info': 'text-info',
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning'
            }[type] || 'text-muted';
            
            logDiv.innerHTML += `<div class="${colorClass}"><small>${time}</small>: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('operationLog').innerHTML = '';
        }
        
        // 載入分類列表
        async function loadCategories() {
            log('載入分類列表...');
            
            try {
                const response = await fetch('api/test_status.php');
                const data = await response.json();
                
                if (data.success) {
                    renderCategories(data.categories);
                    log(`成功載入 ${data.categories.length} 個分類`, 'success');
                } else {
                    log(`載入失敗: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`載入錯誤: ${error.message}`, 'error');
            }
        }
        
        // 渲染分類列表
        function renderCategories(categories) {
            const container = document.getElementById('categoriesList');
            
            if (categories.length === 0) {
                container.innerHTML = '<p class="text-muted">沒有分類資料</p>';
                return;
            }
            
            let html = '';
            categories.forEach(category => {
                const statusBadge = category.status === 'active' ? 
                    `<span class="badge bg-success status-badge" data-category-id="${category.id}" data-new-status="inactive" title="點擊停用">啟用</span>` :
                    `<span class="badge bg-secondary status-badge" data-category-id="${category.id}" data-new-status="active" title="點擊啟用">停用</span>`;
                
                html += `
                    <div class="category-item border-bottom py-2" data-category-id="${category.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-folder me-2"></i>
                                <strong>${category.name}</strong>
                                ${statusBadge}
                            </div>
                            <small class="text-muted">ID: ${category.id}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 切換分類狀態
        async function toggleCategoryStatus(id, newStatus) {
            log(`嘗試切換分類 ${id} 到狀態: ${newStatus}`, 'info');
            
            if (!confirm(`確定要${newStatus === 'active' ? '啟用' : '停用'}此分類嗎？`)) {
                log('用戶取消操作', 'warning');
                return;
            }
            
            try {
                log('發送 API 請求...', 'info');
                
                const response = await fetch('api/test_status.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: id,
                        status: newStatus
                    })
                });
                
                log(`API 回應狀態: ${response.status}`, 'info');
                
                const result = await response.json();
                log(`API 回應內容: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    log(`✅ ${result.message}`, 'success');
                    
                    // 更新頁面上的狀態徽章
                    const categoryItem = document.querySelector(`[data-category-id="${id}"]`);
                    if (categoryItem) {
                        const statusBadge = categoryItem.querySelector('.status-badge');
                        if (statusBadge) {
                            if (newStatus === 'active') {
                                statusBadge.className = 'badge bg-success status-badge';
                                statusBadge.textContent = '啟用';
                                statusBadge.title = '點擊停用';
                                statusBadge.setAttribute('data-new-status', 'inactive');
                            } else {
                                statusBadge.className = 'badge bg-secondary status-badge';
                                statusBadge.textContent = '停用';
                                statusBadge.title = '點擊啟用';
                                statusBadge.setAttribute('data-new-status', 'active');
                            }
                            log('頁面狀態已更新', 'success');
                        }
                    }
                } else {
                    log(`❌ 操作失敗: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`❌ 請求錯誤: ${error.message}`, 'error');
                console.error('完整錯誤:', error);
            }
        }
        
        // 頁面載入和事件處理
        document.addEventListener('DOMContentLoaded', function() {
            log('頁面載入完成，初始化事件監聽器');
            
            // 事件委託處理狀態徽章點擊
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('status-badge')) {
                    log('檢測到狀態徽章點擊', 'info');
                    const categoryId = e.target.getAttribute('data-category-id');
                    const newStatus = e.target.getAttribute('data-new-status');
                    
                    if (categoryId && newStatus) {
                        toggleCategoryStatus(categoryId, newStatus);
                    } else {
                        log('錯誤：缺少必要的屬性', 'error');
                    }
                }
            });
            
            // 載入初始資料
            loadCategories();
        });
    </script>
</body>
</html>
