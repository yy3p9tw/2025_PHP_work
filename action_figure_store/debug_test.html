<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時功能檢查</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">即時功能檢查</h1>
        
        <!-- 導覽列測試 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>導覽列分類下拉測試</h5>
            </div>
            <div class="card-body">
                <div id="navbar-placeholder"></div>
                <button onclick="testNavbarCategories()" class="btn btn-primary mt-2">重新載入分類</button>
                <div id="navbar-status" class="mt-2"></div>
            </div>
        </div>
        
        <!-- 商品圖片測試 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>商品圖片載入測試</h5>
            </div>
            <div class="card-body">
                <div id="image-test" class="row">載入中...</div>
            </div>
        </div>
        
        <!-- 商品分類標籤測試 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>商品分類標籤測試</h5>
            </div>
            <div class="card-body">
                <div id="category-tags-test">載入中...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/navbar.js"></script>
    
    <script>
        // 測試導覽列分類
        function testNavbarCategories() {
            document.getElementById('navbar-status').innerHTML = '<div class="text-info">重新載入分類中...</div>';
            loadCategories();
            
            setTimeout(() => {
                const categoryMenu = document.getElementById('category-dropdown-menu');
                if (categoryMenu && categoryMenu.innerHTML.includes('載入中')) {
                    document.getElementById('navbar-status').innerHTML = '<div class="text-warning">分類仍在載入中，請檢查 API</div>';
                } else if (categoryMenu) {
                    document.getElementById('navbar-status').innerHTML = '<div class="text-success">分類載入成功</div>';
                } else {
                    document.getElementById('navbar-status').innerHTML = '<div class="text-danger">找不到分類選單容器</div>';
                }
            }, 2000);
        }
        
        // 測試商品圖片
        function testProductImages() {
            fetch('api/products.php?page=1&limit=3')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('image-test');
                    
                    if (data.success && data.products) {
                        let html = '';
                        data.products.forEach(product => {
                            html += `
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <img src="${product.image_url}" 
                                             class="card-img-top" 
                                             alt="${product.name}" 
                                             style="height: 200px; object-fit: cover;"
                                             onload="this.style.border='2px solid green'"
                                             onerror="this.style.border='2px solid red'; this.src='assets/images/placeholder_figure.jpg'">
                                        <div class="card-body">
                                            <h6 class="card-title">${product.name}</h6>
                                            <small class="text-muted">圖片路徑: ${product.image_url}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="text-danger">無法載入商品</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('image-test').innerHTML = 
                        `<div class="text-danger">錯誤: ${error.message}</div>`;
                });
        }
        
        // 測試商品分類標籤
        function testCategoryTags() {
            fetch('api/products.php?page=1&limit=3')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('category-tags-test');
                    
                    if (data.success && data.products) {
                        let html = '<div class="row">';
                        data.products.forEach(product => {
                            let categoryInfo = '無分類';
                            if (product.categories && product.categories.length > 0) {
                                categoryInfo = product.categories.map(cat => 
                                    `<span class="badge bg-primary me-1">${cat.name} (ID:${cat.id})</span>`
                                ).join('');
                            }
                            
                            html += `
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">${product.name}</h6>
                                            <div class="mb-2">
                                                <strong>分類：</strong><br>
                                                ${categoryInfo}
                                            </div>
                                            <small class="text-muted">
                                                原始資料: ${JSON.stringify(product.categories)}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="text-danger">無法載入商品分類資料</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('category-tags-test').innerHTML = 
                        `<div class="text-danger">錯誤: ${error.message}</div>`;
                });
        }
        
        // 頁面載入時執行測試
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testProductImages();
                testCategoryTags();
            }, 1000);
        });
    </script>
</body>
</html>
