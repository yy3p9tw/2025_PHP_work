<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最終功能測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">最終功能測試</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">分類 API 測試</h5>
                    </div>
                    <div class="card-body">
                        <div id="categories-test">測試中...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">商品 API 測試</h5>
                    </div>
                    <div class="card-body">
                        <div id="products-test">測試中...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">商品詳情 API 測試</h5>
                    </div>
                    <div class="card-body">
                        <div id="product-detail-test">測試中...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">商品卡片範例（含分類標籤）</h5>
                    </div>
                    <div class="card-body">
                        <div id="product-cards" class="row">載入中...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">頁面連結測試</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="index.html" class="btn btn-outline-primary" target="_blank">首頁</a>
                            <a href="categories.html" class="btn btn-outline-success" target="_blank">分類頁</a>
                            <a href="categories.html?category_id=1&name=動漫公仔" class="btn btn-outline-info" target="_blank">動漫公仔分類</a>
                            <a href="product_detail.html?id=10" class="btn btn-outline-warning" target="_blank">商品詳情</a>
                            <a href="test_frontend.html" class="btn btn-outline-secondary" target="_blank">前端測試</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 測試分類 API
        function testCategoriesAPI() {
            fetch('api/categories.php')
                .then(response => response.json())
                .then(data => {
                    console.log('分類 API 回應:', data);
                    const container = document.getElementById('categories-test');
                    
                    if (data.success && data.categories) {
                        let html = `<div class="text-success mb-2">✓ 成功載入 ${data.categories.length} 個分類</div><div class="small">`;
                        data.categories.forEach(cat => {
                            html += `<div class="mb-1"><strong>${cat.name}</strong> (ID: ${cat.id})`;
                            if (cat.children && cat.children.length > 0) {
                                html += `<div class="ms-3 text-muted">`;
                                cat.children.forEach(child => {
                                    html += `<div>└─ ${child.name} (ID: ${child.id})</div>`;
                                });
                                html += `</div>`;
                            }
                            html += `</div>`;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `<div class="text-danger">✗ 失敗: ${data.error || '未知錯誤'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('分類 API 錯誤:', error);
                    document.getElementById('categories-test').innerHTML = 
                        `<div class="text-danger">✗ 網路錯誤: ${error.message}</div>`;
                });
        }

        // 測試商品 API
        function testProductsAPI() {
            fetch('api/products.php?page=1&limit=5')
                .then(response => response.json())
                .then(data => {
                    console.log('商品 API 回應:', data);
                    const container = document.getElementById('products-test');
                    
                    if (data.success && data.products) {
                        let html = `<div class="text-success mb-2">✓ 成功載入 ${data.products.length} 個商品</div><div class="small">`;
                        data.products.forEach(product => {
                            html += `<div class="mb-2"><strong>${product.name}</strong> - $${product.price}`;
                            if (product.categories && product.categories.length > 0) {
                                html += `<div class="text-primary">分類: ${product.categories.map(c => c.name).join(', ')}</div>`;
                            }
                            html += `</div>`;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `<div class="text-danger">✗ 失敗: ${data.error || '未知錯誤'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('商品 API 錯誤:', error);
                    document.getElementById('products-test').innerHTML = 
                        `<div class="text-danger">✗ 網路錯誤: ${error.message}</div>`;
                });
        }

        // 測試商品詳情 API
        function testProductDetailAPI() {
            fetch('api/product_detail.php?id=10')
                .then(response => response.json())
                .then(data => {
                    console.log('商品詳情 API 回應:', data);
                    const container = document.getElementById('product-detail-test');
                    
                    if (data.success && data.product) {
                        const product = data.product;
                        let html = `<div class="text-success mb-2">✓ 成功載入商品詳情</div>
                                   <div class="small">
                                   <strong>${product.name}</strong><br>
                                   價格: $${product.price}<br>
                                   描述: ${product.description || '無'}<br>`;
                        if (product.categories && product.categories.length > 0) {
                            html += `<div class="text-primary">分類: ${product.categories.map(c => c.name).join(', ')}</div>`;
                        }
                        html += `</div>`;
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `<div class="text-danger">✗ 失敗: ${data.error || '未知錯誤'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('商品詳情 API 錯誤:', error);
                    document.getElementById('product-detail-test').innerHTML = 
                        `<div class="text-danger">✗ 網路錯誤: ${error.message}</div>`;
                });
        }

        // 渲染商品卡片範例
        function renderProductCards() {
            fetch('api/products.php?page=1&limit=3')
                .then(response => response.json())
                .then(data => {
                    console.log('商品卡片 API 回應:', data);
                    const container = document.getElementById('product-cards');
                    
                    if (data.success && data.products) {
                        let html = '';
                        data.products.forEach(product => {
                            // 渲染分類標籤
                            let categoryTags = '';
                            if (product.categories && product.categories.length > 0) {
                                categoryTags = `
                                    <div class="category-tags mb-2">
                                        ${product.categories.map(cat => 
                                            `<a href="categories.html?category_id=${cat.id}&name=${encodeURIComponent(cat.name)}" 
                                               class="badge bg-light text-primary text-decoration-none me-1">${cat.name}</a>`
                                        ).join('')}
                                    </div>
                                `;
                            }
                            
                            html += `
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100">
                                        <img src="${product.image_url}" class="card-img-top" alt="${product.name}" 
                                             style="height: 200px; object-fit: cover;"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWVhuWTgOWcluePnjwvdGV4dD48L3N2Zz4='">
                                        <div class="card-body">
                                            <h6 class="card-title">${product.name}</h6>
                                            <p class="card-text small text-muted">${product.description || '暫無描述'}</p>
                                            ${categoryTags}
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-primary fw-bold">$${parseFloat(product.price).toLocaleString()}</span>
                                                <a href="product_detail.html?id=${product.id}" class="btn btn-outline-primary btn-sm">
                                                    查看詳情
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<div class="text-danger">無法載入商品卡片</div>';
                    }
                })
                .catch(error => {
                    console.error('商品卡片錯誤:', error);
                    document.getElementById('product-cards').innerHTML = 
                        `<div class="text-danger">載入錯誤: ${error.message}</div>`;
                });
        }

        // 執行所有測試
        document.addEventListener('DOMContentLoaded', function() {
            console.log('開始執行所有測試...');
            testCategoriesAPI();
            testProductsAPI();
            testProductDetailAPI();
            renderProductCards();
        });
    </script>
</body>
</html>
